include(ExternalProject)

set(PNG_VERSION            1.6.37)
set(PNG_INSTALL_DIR        "${CMAKE_BINARY_DIR}/_vendor")
set(PNG_INCLUDE_DIRECTORY  "${PNG_INSTALL_DIR}/include")
set(PNG_LIBRARY_DIRECTORY  "${PNG_INSTALL_DIR}/lib")

file(MAKE_DIRECTORY "${PNG_INCLUDE_DIRECTORY}")
file(MAKE_DIRECTORY "${PNG_LIBRARY_DIRECTORY}")

if (WIN32)
    set(PNG_IMPORTED_LOCATION_DEBUG    "${PNG_INSTALL_DIR}/bin/${CMAKE_SHARED_LIBRARY_PREFIX}libpng16d${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(PNG_IMPORTED_IMPLIB_DEBUG      "${PNG_INSTALL_DIR}/lib/${CMAKE_IMPORT_LIBRARY_PREFIX}libpng16d${CMAKE_IMPORT_LIBRARY_SUFFIX}")
    set(PNG_IMPORTED_LOCATION          "${PNG_INSTALL_DIR}/bin/${CMAKE_SHARED_LIBRARY_PREFIX}libpng16${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(PNG_IMPORTED_IMPLIB            "${PNG_INSTALL_DIR}/lib/${CMAKE_IMPORT_LIBRARY_PREFIX}libpng16${CMAKE_IMPORT_LIBRARY_SUFFIX}")
else()
    set(PNG_IMPORTED_LOCATION           "${PNG_INSTALL_DIR}/lib/${CMAKE_SHARED_LIBRARY_PREFIX}png${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(PNG_IMPORTED_LOCATION_DEBUG     "${PNG_IMPORTED_LOCATION}")
endif()

ExternalProject_Add(
    ep_libpng
    URL             "https://github.com/glennrp/libpng/archive/refs/tags/v${PNG_VERSION}.tar.gz"
    INSTALL_DIR     "${PNG_INSTALL_DIR}"
    CMAKE_ARGS
        "-DCMAKE_BUILD_TYPE=$<CONFIG>"
        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
        "-DCMAKE_ASM_COMPILER=${CMAKE_C_COMPILER}"
)
add_dependencies(ep_libpng ZLIB::ZLIB)

add_library(PNG::PNG SHARED IMPORTED GLOBAL)
set_target_properties(
    PNG::PNG
    PROPERTIES

    INTERFACE_INCLUDE_DIRECTORIES   "${PNG_INCLUDE_DIRECTORY}"
    IMPORTED_LOCATION_DEBUG         "${PNG_IMPORTED_LOCATION_DEBUG}"
    IMPORTED_LOCATION               "${PNG_IMPORTED_LOCATION}"
    IMPORTED_IMPLIB_DEBUG           "${PNG_IMPORTED_IMPLIB_DEBUG}"
    IMPORTED_IMPLIB                 "${PNG_IMPORTED_IMPLIB}"
)
add_dependencies(PNG::PNG ep_libpng)
